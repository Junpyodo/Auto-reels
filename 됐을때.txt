# main.py
import os
import random
import time
import json
import traceback
import requests
import subprocess
from openai import OpenAI
from moviepy.editor import VideoFileClip, TextClip, CompositeVideoClip
import moviepy.video.fx.all as vfx

# optional AWS helper (ìˆìœ¼ë©´ ì‚¬ìš©)
try:
Â  Â  from aws_upload import upload_file_to_s3
except Exception:
Â  Â  upload_file_to_s3 = None

# --- ì„¤ì • (ë ˆí¬ì— ì´ë¯¸ ì¡´ì¬í•˜ë˜ ì‹œí¬ë¦¿/í™˜ê²½ë³€ìˆ˜ ì´ë¦„ ìœ ì§€) ---
GITHUB_ID = "Junpyodo"
REPO_NAME = "Auto-reels"

TOPIC_FILE = "topics.txt"
EMERGENCY_FILE = "emergency_scripts.txt"
USED_SCRIPTS_FILE = "used_scripts.json"

ACCESS_TOKEN = os.getenv("INSTAGRAM_ACCESS_TOKEN")
ACCOUNT_ID = os.getenv("INSTAGRAM_ACCOUNT_ID")
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")Â  # Actionsì—ì„œ ìë™ ì œê³µ ê°€ëŠ¥

HASHTAGS = "#wealth #success #darkpsychology #motivation #millionaire #mindset"
MENTIONS = "@instagram"

AI_MODELS = [
Â  Â  "google/gemini-2.0-flash-exp:free",
Â  Â  "google/gemini-flash-1.5-8b:free",
Â  Â  "openai/gpt-4o-mini-2024-07-18:free",
Â  Â  "meta-llama/llama-3.1-8b-instruct:free"
]

# -------------- ìœ í‹¸ --------------
def get_list_from_file(file_path, default_values):
Â  Â  if not os.path.exists(file_path):
Â  Â  Â  Â  with open(file_path, "w", encoding="utf-8") as f:
Â  Â  Â  Â  Â  Â  f.write("\n".join(default_values))
Â  Â  Â  Â  return default_values[:]
Â  Â  with open(file_path, "r", encoding="utf-8") as f:
Â  Â  Â  Â  return [line.strip() for line in f.readlines() if line.strip()]

def save_list_to_file(file_path, items):
Â  Â  with open(file_path, "w", encoding="utf-8") as f:
Â  Â  Â  Â  f.write("\n".join(items))

def load_json(path, default):
Â  Â  if not os.path.exists(path):
Â  Â  Â  Â  with open(path, "w", encoding="utf-8") as f:
Â  Â  Â  Â  Â  Â  json.dump(default, f, ensure_ascii=False, indent=2)
Â  Â  Â  Â  return default
Â  Â  with open(path, "r", encoding="utf-8") as f:
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  return json.load(f)
Â  Â  Â  Â  except Exception:
Â  Â  Â  Â  Â  Â  return default

def save_json(path, obj):
Â  Â  with open(path, "w", encoding="utf-8") as f:
Â  Â  Â  Â  json.dump(obj, f, ensure_ascii=False, indent=2)

def safe_extract_text_from_openai_response(resp):
Â  Â  try:
Â  Â  Â  Â  if isinstance(resp, dict):
Â  Â  Â  Â  Â  Â  if "choices" in resp and len(resp["choices"]) > 0:
Â  Â  Â  Â  Â  Â  Â  Â  ch0 = resp["choices"][0]
Â  Â  Â  Â  Â  Â  Â  Â  if "message" in ch0 and isinstance(ch0["message"], dict) and "content" in ch0["message"]:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return ch0["message"]["content"].strip()
Â  Â  Â  Â  Â  Â  Â  Â  if "text" in ch0 and ch0["text"]:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return ch0["text"].strip()
Â  Â  Â  Â  if hasattr(resp, "choices") and len(resp.choices) > 0:
Â  Â  Â  Â  Â  Â  ch0 = resp.choices[0]
Â  Â  Â  Â  Â  Â  if hasattr(ch0, "message") and hasattr(ch0.message, "content"):
Â  Â  Â  Â  Â  Â  Â  Â  return ch0.message.content.strip()
Â  Â  Â  Â  Â  Â  if hasattr(ch0, "text"):
Â  Â  Â  Â  Â  Â  Â  Â  return ch0.text.strip()
Â  Â  except Exception:
Â  Â  Â  Â  pass
Â  Â  return ""

# -------------- AI ê´€ë ¨ --------------
def update_emergency_scripts(used_script=None):
Â  Â  scripts = get_list_from_file(EMERGENCY_FILE, ["Work in silence.", "Success is the best revenge."])
Â  Â  if used_script and used_script in scripts:
Â  Â  Â  Â  scripts.remove(used_script)

Â  Â  if not OPENROUTER_API_KEY:
Â  Â  Â  Â  save_list_to_file(EMERGENCY_FILE, scripts)
Â  Â  Â  Â  print("âš ï¸ OPENROUTER_API_KEYê°€ ì—†ìŠµë‹ˆë‹¤ â€” emergency ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€")
Â  Â  Â  Â  return

Â  Â  client = OpenAI(base_url="https://openrouter.ai/api/v1", api_key=OPENROUTER_API_KEY)
Â  Â  prompt = "Generate 10 powerful, viral 20-word dark psychology scripts for Instagram Reels. One per line. No numbers."

Â  Â  for model in AI_MODELS:
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  time.sleep(1)
Â  Â  Â  Â  Â  Â  resp = client.chat.completions.create(model=model, messages=[{"role":"user","content":prompt}])
Â  Â  Â  Â  Â  Â  text = safe_extract_text_from_openai_response(resp)
Â  Â  Â  Â  Â  Â  if not text:
Â  Â  Â  Â  Â  Â  Â  Â  continue
Â  Â  Â  Â  Â  Â  new_list = [line.strip().replace('"','') for line in text.split("\n") if line.strip()]
Â  Â  Â  Â  Â  Â  if new_list:
Â  Â  Â  Â  Â  Â  Â  Â  combined = list(dict.fromkeys(scripts + new_list))
Â  Â  Â  Â  Â  Â  Â  Â  save_list_to_file(EMERGENCY_FILE, combined)
Â  Â  Â  Â  Â  Â  Â  Â  print(f"âœ… ë¹„ìƒ ëŒ€ë³¸ ë¦¬ìŠ¤íŠ¸ ë³´ì¶© ì™„ë£Œ ({model})")
Â  Â  Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  print(f"âš ï¸ update_emergency_scripts: {model} ì‹¤íŒ¨: {e}")
Â  Â  Â  Â  Â  Â  continue
Â  Â  save_list_to_file(EMERGENCY_FILE, scripts)
Â  Â  print("âš ï¸ ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ â€” emergency ë¦¬ìŠ¤íŠ¸ëŠ” ìœ ì§€ë¨")

def update_topics_list(used_topic):
Â  Â  if not OPENROUTER_API_KEY:
Â  Â  Â  Â  print("âš ï¸ OPENROUTER_API_KEYê°€ ì—†ìŠµë‹ˆë‹¤ â€” ì£¼ì œ ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€")
Â  Â  Â  Â  return

Â  Â  topics = get_list_from_file(TOPIC_FILE, ["Wealth psychology"])
Â  Â  if used_topic in topics:
Â  Â  Â  Â  topics.remove(used_topic)

Â  Â  client = OpenAI(base_url="https://openrouter.ai/api/v1", api_key=OPENROUTER_API_KEY)
Â  Â  prompt = f"Based on {used_topic}, generate 10 new Instagram Reel topics about dark psychology and wealth. Newlines only."

Â  Â  for model in AI_MODELS:
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  time.sleep(1)
Â  Â  Â  Â  Â  Â  resp = client.chat.completions.create(model=model, messages=[{"role":"user","content":prompt}])
Â  Â  Â  Â  Â  Â  text = safe_extract_text_from_openai_response(resp)
Â  Â  Â  Â  Â  Â  if not text:
Â  Â  Â  Â  Â  Â  Â  Â  continue
Â  Â  Â  Â  Â  Â  new_topics = [line.strip() for line in text.split("\n") if line.strip()]
Â  Â  Â  Â  Â  Â  if new_topics:
Â  Â  Â  Â  Â  Â  Â  Â  combined = list(dict.fromkeys(topics + new_topics))
Â  Â  Â  Â  Â  Â  Â  Â  save_list_to_file(TOPIC_FILE, combined)
Â  Â  Â  Â  Â  Â  Â  Â  print(f"âœ… ì£¼ì œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ ({model})")
Â  Â  Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  print(f"âš ï¸ update_topics_list: {model} ì‹¤íŒ¨: {e}")
Â  Â  Â  Â  Â  Â  continue
Â  Â  print("âš ï¸ ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ â€” ì£¼ì œ ë¦¬ìŠ¤íŠ¸ ë³€ê²½ ì•ˆë¨")

def get_best_sales_script(selected_topic, max_attempts_per_model=2):
Â  Â  if not OPENROUTER_API_KEY:
Â  Â  Â  Â  e_scripts = get_list_from_file(EMERGENCY_FILE, ["The 1% don't sleep until the job is done."])
Â  Â  Â  Â  return random.choice(e_scripts), True

Â  Â  used_scripts = load_json(USED_SCRIPTS_FILE, [])
Â  Â  client = OpenAI(base_url="https://openrouter.ai/api/v1", api_key=OPENROUTER_API_KEY)
Â  Â  prompt_content = f"Topic: {selected_topic}\nCreate a powerful 20-word dark psychology script for an Instagram Reel. No intro. Provide exactly one line."

Â  Â  print("ğŸ¤– AI ëŒ€ë³¸ ìƒì„± ì‹œë„ ì¤‘...")
Â  Â  for model in AI_MODELS:
Â  Â  Â  Â  for attempt in range(max_attempts_per_model):
Â  Â  Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  Â  Â  time.sleep(1 + attempt)
Â  Â  Â  Â  Â  Â  Â  Â  resp = client.chat.completions.create(model=model, messages=[{"role":"user","content":prompt_content}])
Â  Â  Â  Â  Â  Â  Â  Â  script = safe_extract_text_from_openai_response(resp).replace('"','').strip()
Â  Â  Â  Â  Â  Â  Â  Â  if not script:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue
Â  Â  Â  Â  Â  Â  Â  Â  script_line = script.split("\n")[0].strip()
Â  Â  Â  Â  Â  Â  Â  Â  if len(script_line) < 6:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue
Â  Â  Â  Â  Â  Â  Â  Â  if script_line in used_scripts:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  print("âš ï¸ ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ë¯¸ ì‚¬ìš©ë¨ â€” ê±´ë„ˆëœ€")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue
Â  Â  Â  Â  Â  Â  Â  Â  print(f"âœ¨ [AI ìƒì„± ì„±ê³µ] ëª¨ë¸: {model}")
Â  Â  Â  Â  Â  Â  Â  Â  used_scripts.append(script_line)
Â  Â  Â  Â  Â  Â  Â  Â  save_json(USED_SCRIPTS_FILE, used_scripts)
Â  Â  Â  Â  Â  Â  Â  Â  return script_line, False
Â  Â  Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  Â  Â  print(f"âš ï¸ {model} ì‹¤íŒ¨ (ì‹œë„ {attempt+1}): {e}")
Â  Â  Â  Â  Â  Â  Â  Â  continue

Â  Â  print("ğŸ†˜ ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ â€” ë¹„ìƒ ëŒ€ë³¸ ì‚¬ìš©")
Â  Â  e_scripts = get_list_from_file(EMERGENCY_FILE, ["The 1% don't sleep until the job is done."])
Â  Â  chosen = random.choice(e_scripts)
Â  Â  used = load_json(USED_SCRIPTS_FILE, [])
Â  Â  used.append(chosen)
Â  Â  save_json(USED_SCRIPTS_FILE, used)
Â  Â  return chosen, True

# -------------- ì™¸ë¶€ ì—…ë¡œë“œ(ê³µê°œ URL í™•ë³´) --------------
def upload_to_0x0(file_path, max_attempts=2):
Â  Â  url = "https://0x0.st"
Â  Â  for attempt in range(max_attempts):
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  with open(file_path,"rb") as f:
Â  Â  Â  Â  Â  Â  Â  Â  files={'file':(os.path.basename(file_path), f)}
Â  Â  Â  Â  Â  Â  Â  Â  r = requests.post(url, files=files, timeout=60)
Â  Â  Â  Â  Â  Â  if r.status_code in (200,201) and r.text.strip().startswith("http"):
Â  Â  Â  Â  Â  Â  Â  Â  return r.text.strip()
Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  print(f"âš ï¸ 0x0.st ì‹¤íŒ¨({r.status_code}):{r.text}")
Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  print("âš ï¸ 0x0.st ì˜ˆì™¸:", e)
Â  Â  Â  Â  time.sleep(2*(attempt+1))
Â  Â  return None

def upload_to_transfersh(file_path, max_attempts=2):
Â  Â  for attempt in range(max_attempts):
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  url = f"https://transfer.sh/{os.path.basename(file_path)}"
Â  Â  Â  Â  Â  Â  with open(file_path,"rb") as f:
Â  Â  Â  Â  Â  Â  Â  Â  r = requests.put(url, data=f, timeout=120)
Â  Â  Â  Â  Â  Â  if r.status_code in (200,201):
Â  Â  Â  Â  Â  Â  Â  Â  return r.text.strip()
Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  print(f"âš ï¸ transfer.sh ì‹¤íŒ¨({r.status_code}): {r.text}")
Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  print("âš ï¸ transfer.sh ì˜ˆì™¸:", e)
Â  Â  Â  Â  time.sleep(2*(attempt+1))
Â  Â  return None

def gh_pages_publish(file_path):
Â  Â  """
Â  Â  [ì—ëŸ¬ í•´ê²° ë²„ì „] Git ì‚¬ìš©ì ì •ë³´ ì„¤ì • ë° gh-pages ë¸Œëœì¹˜ ìë™ ìƒì„± ê¸°ëŠ¥ ì¶”ê°€
Â  Â  """
Â  Â  if not GITHUB_TOKEN:
Â  Â  Â  Â  print("â„¹ï¸ GITHUB_TOKENì´ ì—†ì–´ gh-pages ë°°í¬ ë¶ˆê°€.")
Â  Â  Â  Â  return None
Â  Â  try:
Â  Â  Â  Â  dest_path = os.path.basename(file_path)
Â  Â  Â  Â  repo_url = f"https://x-access-token:{GITHUB_TOKEN}@github.com/{GITHUB_ID}/{REPO_NAME}.git"
Â  Â  Â  Â  workdir = "/tmp/auto-reels-ghpages"
Â  Â  Â  Â Â 
Â  Â  Â  Â  subprocess.run(["rm", "-rf", workdir], check=False)
Â  Â  Â  Â  subprocess.run(["git", "clone", repo_url, workdir], check=True)
Â  Â  Â  Â Â 
Â  Â  Â  Â  # Git Identity ì„¤ì • (ì—ëŸ¬ ë°©ì§€ í•µì‹¬)
Â  Â  Â  Â  subprocess.run(["git", "config", "user.name", "github-actions[bot]"], cwd=workdir, check=True)
Â  Â  Â  Â  subprocess.run(["git", "config", "user.email", "github-actions[bot]@users.noreply.github.com"], cwd=workdir, check=True)

Â  Â  Â  Â  # gh-pages ë¸Œëœì¹˜ ì—†ìœ¼ë©´ ìƒì„±
Â  Â  Â  Â  ret = subprocess.run(["git", "checkout", "gh-pages"], cwd=workdir, capture_output=True)
Â  Â  Â  Â  if ret.returncode != 0:
Â  Â  Â  Â  Â  Â  print("ğŸŒ± gh-pages ë¸Œëœì¹˜ë¥¼ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.")
Â  Â  Â  Â  Â  Â  subprocess.run(["git", "checkout", "--orphan", "gh-pages"], cwd=workdir, check=True)
Â  Â  Â  Â  Â  Â  subprocess.run(["git", "rm", "-rf", "."], cwd=workdir, check=True)

Â  Â  Â  Â  dest = os.path.join(workdir, dest_path)
Â  Â  Â  Â  subprocess.run(["cp", file_path, dest], check=True)
Â  Â  Â  Â  subprocess.run(["git", "add", dest_path], cwd=workdir, check=True)
Â  Â  Â  Â  subprocess.run(["git", "commit", "-m", "ğŸš€ Add latest reel video"], cwd=workdir, check=True)
Â  Â  Â  Â  subprocess.run(["git", "push", "origin", "gh-pages"], cwd=workdir, check=True)
Â  Â  Â  Â Â 
Â  Â  Â  Â  public_url = f"https://{GITHUB_ID}.github.io/{REPO_NAME}/{dest_path}"
Â  Â  Â  Â  print("ğŸ”— gh-pages ì—…ë¡œë“œ ì™„ë£Œ:", public_url)
Â  Â  Â  Â  return public_url
Â  Â  except Exception as e:
Â  Â  Â  Â  print("âŒ gh-pages ì—…ë¡œë“œ ì‹¤íŒ¨:", e)
Â  Â  Â  Â  return None

def upload_video_and_get_public_url(file_path):
Â  Â  if upload_file_to_s3:
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  print("ğŸ”¼ S3 ì—…ë¡œë“œ ì‹œë„...")
Â  Â  Â  Â  Â  Â  s3_url = upload_file_to_s3(file_path)
Â  Â  Â  Â  Â  Â  if s3_url:
Â  Â  Â  Â  Â  Â  Â  Â  print("ğŸ”— S3 ì—…ë¡œë“œ ì„±ê³µ:", s3_url)
Â  Â  Â  Â  Â  Â  Â  Â  return s3_url
Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  print("âš ï¸ S3 ì—…ë¡œë“œ ì˜ˆì™¸:", e)

Â  Â  gh_url = gh_pages_publish(file_path)
Â  Â  if gh_url:
Â  Â  Â  Â  return gh_url

Â  Â  print("ğŸ”¼ 0x0.st ì—…ë¡œë“œ ì‹œë„...")
Â  Â  url = upload_to_0x0(file_path)
Â  Â  if url: return url

Â  Â  print("ğŸ”¼ transfer.sh ì—…ë¡œë“œ ì‹œë„...")
Â  Â  url = upload_to_transfersh(file_path)
Â  Â  if url: return url

Â  Â  print("âŒ ê³µê°œ URL ìƒì„± ì‹¤íŒ¨")
Â  Â  return None

# -------------- Instagram ì—…ë¡œë“œ --------------
def post_to_instagram(video_url, caption, api_version="v19.0"):
Â  Â  # 1. í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (í•¨ìˆ˜ ë‚´ ì •ì˜ë¡œ ì•ˆì „ì„± í™•ë³´)
Â  Â  ACCESS_TOKEN = os.getenv("INSTAGRAM_ACCESS_TOKEN")
Â  Â  ACCOUNT_ID = os.getenv("INSTAGRAM_ACCOUNT_ID")

Â  Â  if not ACCESS_TOKEN or not ACCOUNT_ID:
Â  Â  Â  Â  print("âŒ INSTAGRAM_ACCESS_TOKEN ë˜ëŠ” INSTAGRAM_ACCOUNT_IDê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.")
Â  Â  Â  Â  return False

Â  Â  print("ğŸ“¤ ì¸ìŠ¤íƒ€ ì—…ë¡œë“œ ì‹œë„. URL:", video_url)
Â  Â Â 
Â  Â  # 2. ë¯¸ë””ì–´ ì»¨í…Œì´ë„ˆ ìƒì„± ì£¼ì†Œ
Â  Â  container_url = f"https://graph.facebook.com/{api_version}/{ACCOUNT_ID}/media"

Â  Â  payload = {
Â  Â  Â  Â  'media_type': 'REELS',
Â  Â  Â  Â  'video_url': video_url,
Â  Â  Â  Â  'caption': caption,
Â  Â  Â  Â  'share_to_feed': 'true',Â 
Â  Â  Â  Â  'access_token': ACCESS_TOKEN
Â  Â  }
Â  Â Â 
Â  Â  try:
Â  Â  Â  Â  # 3. ì»¨í…Œì´ë„ˆ ìƒì„±
Â  Â  Â  Â  r = requests.post(container_url, data=payload, timeout=30)
Â  Â  Â  Â  res = r.json()
Â  Â  Â  Â  print("â–¶ container create response:", res)
Â  Â  Â  Â Â 
Â  Â  Â  Â  if "id" not in res:
Â  Â  Â  Â  Â  Â  print("âŒ ì»¨í…Œì´ë„ˆ ìƒì„± ì‹¤íŒ¨:", res)
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  creation_id = res.get("id")

Â  Â  Â  Â  # 4. í´ë§(Polling): ì¸ìŠ¤íƒ€ê·¸ë¨ ì„œë²„ì˜ ì˜ìƒ ì²˜ë¦¬ ìƒíƒœ í™•ì¸
Â  Â  Â  Â  print("â³ ì¸ìŠ¤íƒ€ê·¸ë¨ ì„œë²„ì—ì„œ ì˜ìƒ ì²˜ë¦¬ ìƒíƒœ í™•ì¸ ì¤‘...")
Â  Â  Â  Â  status_url = f"https://graph.facebook.com/{api_version}/{creation_id}"
Â  Â  Â  Â  status_params = {'fields': 'status_code', 'access_token': ACCESS_TOKEN}
Â  Â  Â  Â Â 
Â  Â  Â  Â  for i in range(20): # ìµœëŒ€ 100ì´ˆ (5ì´ˆ * 20ë²ˆ)
Â  Â  Â  Â  Â  Â  time.sleep(5)
Â  Â  Â  Â  Â  Â  check_r = requests.get(status_url, params=status_params, timeout=30)
Â  Â  Â  Â  Â  Â  status_res = check_r.json()
Â  Â  Â  Â  Â  Â  status_code = status_res.get("status_code", "").upper()
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  print(f"Â  Â - ìƒíƒœ í™•ì¸ ({i+1}/20): {status_code}")
Â  Â  Â  Â  Â  Â  if status_code == "FINISHED":
Â  Â  Â  Â  Â  Â  Â  Â  break
Â  Â  Â  Â  Â  Â  elif status_code == "ERROR":
Â  Â  Â  Â  Â  Â  Â  Â  print("âŒ ì˜ìƒ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:", status_res)
Â  Â  Â  Â  Â  Â  Â  Â  return False

Â  Â  Â  Â  # 5. ìµœì¢… ê²Œì‹œ (Publish)
Â  Â  Â  Â  print("ğŸš€ ì˜ìƒ ì²˜ë¦¬ ì™„ë£Œ. ìµœì¢… ê²Œì‹œ ì¤‘...")
Â  Â  Â  Â  publish_url = f"https://graph.facebook.com/{api_version}/{ACCOUNT_ID}/media_publish"
Â  Â  Â  Â  publish_payload = {
Â  Â  Â  Â  Â  Â  'creation_id': creation_id,
Â  Â  Â  Â  Â  Â  'access_token': ACCESS_TOKEN
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  r_pub = requests.post(publish_url, data=publish_payload, timeout=30)
Â  Â  Â  Â  pub_res = r_pub.json()
Â  Â  Â  Â Â 
Â  Â  Â  Â  if 'id' in pub_res:
Â  Â  Â  Â  Â  Â  print("ğŸ‰ ì—…ë¡œë“œ ì„±ê³µ! ê²Œì‹œë¬¼ ID:", pub_res.get("id"))
Â  Â  Â  Â  Â  Â  return True
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  print("âŒ ìµœì¢… ê²Œì‹œ ì‹¤íŒ¨:", pub_res)
Â  Â  Â  Â  Â  Â  return False

Â  Â  except Exception as e:
Â  Â  Â  Â  print("âŒ API ì˜ˆì™¸ ë°œìƒ:", e)
Â  Â  Â  Â  return False

# -------------- ë©”ì¸ íë¦„ --------------
def run_reels_bot():
Â  Â  if not os.path.exists("background.mp4"):
Â  Â  Â  Â  print("âŒ background.mp4 íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.")
Â  Â  Â  Â  return

Â  Â  topics = get_list_from_file(TOPIC_FILE, ["Dark psychology of wealth"])
Â  Â  selected_topic = random.choice(topics)
Â  Â  print("ğŸ¯ ì£¼ì œ:", selected_topic)

Â  Â  script, is_emergency = get_best_sales_script(selected_topic)
Â  Â  final_caption = f"{script}\n\n{MENTIONS}\n\n{HASHTAGS}"

Â  Â  try:
Â  Â  Â  Â  print("ğŸ¬ ì˜ìƒ í¸ì§‘ ì‹œì‘...")
Â  Â  Â  Â  video = VideoFileClip("background.mp4").subclip(0,8).fx(vfx.colorx, 0.25)
Â  Â  Â  Â  txt = TextClip(script, fontsize=45, color='white', size=(int(video.w*0.85), None),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â font='DejaVu-Sans-Bold', method='caption', align='center',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â interline=12, stroke_color='black', stroke_width=1.5).set_duration(8).set_pos('center')
Â  Â  Â  Â  final = CompositeVideoClip([video, txt])
Â  Â  Â  Â  final_video_name = "reels_video.mp4"
Â  Â  Â  Â  final.write_videofile(final_video_name, fps=24, codec="libx264", audio=False)
Â  Â  except Exception as e:
Â  Â  Â  Â  print("âŒ ì˜ìƒ ì œì‘ ì˜¤ë¥˜:", e)
Â  Â  Â  Â  return

Â  Â  public_url = upload_video_and_get_public_url(final_video_name)
Â  Â  if not public_url:
Â  Â  Â  Â  print("âŒ ê³µê°œ URL ìƒì„± ì‹¤íŒ¨.")
Â  Â  Â  Â  return

Â  Â  print("â³ ë°°í¬ ì•ˆì •í™”ë¥¼ ìœ„í•´ 60ì´ˆ ëŒ€ê¸° í›„ ì¸ìŠ¤íƒ€ê·¸ë¨ ì „ì†¡ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
Â  Â  time.sleep(60)

Â  Â  # ë“œë””ì–´ ì¸ìŠ¤íƒ€ê·¸ë¨ ì—…ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
Â  Â  success = post_to_instagram(public_url, final_caption)

Â  Â  # ê²°ê³¼ì— ë”°ë¥¸ í›„ì† ì²˜ë¦¬ (ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë“±)
Â  Â  if success:
Â  Â  Â  Â  print("âœ… ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
Â  Â  Â  Â  if is_emergency:
Â  Â  Â  Â  Â  Â  update_emergency_scripts(used_script=script)
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  update_topics_list(used_topic=selected_topic)
Â  Â  Â  Â  Â  Â  update_emergency_scripts()
Â  Â  else:
Â  Â  Â  Â  print("âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.")

if __name__ == "__main__":
Â  Â  run_reels_bot()